name: Publish Solution Dependencies

on:
  push:
    branches: [ rob/automated-ci-678 ]

jobs:
  publish:
    name: Publish Dependency DLLsÔ∏è
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - name: update submodules
        # clone submodules
        run: |
          git submodule update --init
        shell: bash
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 6.0.x
      - name: Publish Solution DLLs
        run: |
          dotnet publish --no-restore src/ChainSafe.Gaming.Unity/ChainSafe.Gaming.Unity.csproj -c Release /property:Unity=true
      - name: Move DLLs to Unity Packages then Commit and Push
        run: |
          
          git config user.email $git_email
          git config user.name "${{ github.actor }}"
          
          export PUBLISH_PATH="${GITHUB_WORKSPACE}/${{ vars.PUBLISH_PATH }}"
          
          rm -f $PUBLISH_PATH/Newtonsoft.Json.dll
          rm -f $PUBLISH_PATH/UnityEngine.dll
          rm -f $PUBLISH_PATH/Microsoft.CSharp.dll
          
          export PACKAGE_DEPENDENCIES=${{ vars.PACKAGE_DEPENDENCIES }}
          
          for entry in "${PACKAGE_DEPENDENCIES[@]}"
          do
            IFS=':' read -ra dirs <<< "$entry"
            export PACKAGE_LIB_PATH="${GITHUB_WORKSPACE}/${dirs[0]}"
            
            rm -rf "$PACKAGE_LIB_PATH"
            mkdir -p "$PACKAGE_LIB_PATH"
            
            IFS=';' read -ra dependencies <<< "${dirs[1]}"
            
            for dependency in "${dependencies[@]}"
            do
              cp "$PUBLISH_PATH/$dependency.dll" "$PACKAGE_LIB_PATH"
            done
          
            git add "$PACKAGE_LIB_PATH." -f
          done
          
          git diff-index --cached --quiet HEAD || git commit -m "Published Solution Dependencies to Package Libraries as DLLs"
          git push
        env:
          git_email: "${{ github.actor }}@users.noreply.github.com"