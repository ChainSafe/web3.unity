name: Pull Request Checks

on:
  workflow_call:

jobs:
  check_commit:
    name: Check Commit 📝
    runs-on: ubuntu-latest
    outputs:
      commit_message: ${{ steps.get_head_commit_message.outputs.HEAD_COMMIT_MESSAGE }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          lfs: true
          ssh-key: ${{ secrets.DEPLOY_KEY }}
      - name: Get Head Commit Message
        id: get_head_commit_message
        run: echo "HEAD_COMMIT_MESSAGE=$(git show -s --format=%s)" >> "$GITHUB_OUTPUT"
  
  web3_tests:
    name: Web3 tests 🕸
    if: ${{ needs.check_commit.outputs.commit_message == 'Sync Dependencies' }}
    uses: ChainSafe/web3.unity/.github/workflows/test.yaml@main
    needs: [ check_commit ]
  analyze_code:
    name: Analyze 🧐
    if: ${{ github.event.action == 'ready_for_review' || github.event.label.name == 'ready-to-merge'}}
    uses: ChainSafe/web3.unity/.github/workflows/codeql.yml@main
  unity_tests:
    name: Unity Tests 🧪
    if: ${{ github.event.action == 'ready_for_review' || github.event.label.name == 'ready-to-merge'}}
    uses: ChainSafe/web3.unity/.github/workflows/unity_tests.yml@main
    secrets: inherit
  sync_dependencies:
    name: Sync Dependencies 🔄
    if: ${{ github.base_ref == 'main' && github.event.label.name == 'sync' }}
    uses: ChainSafe/web3.unity/.github/workflows/sync_dependencies.yaml@main
    secrets: inherit
  duplicate_samples:
    name: Duplicate Samples 🪞
    uses: ChainSafe/web3.unity/.github/workflows/duplicate_samples.yaml@main
    needs: [ sync_dependencies ]
    secrets: inherit
  label_pr:
    name: Label Pull Request
    uses: ChainSafe/web3.unity/.github/workflows/labeler.yaml@rob/ci-fix-1
    needs: [ duplicate_samples ]
    secrets: inherit