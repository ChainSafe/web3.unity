name: Check and Commit

on:
  workflow_call:

jobs:
  duplicate_samples_and_publish_dependencies:
    name: Duplicate Samples And Publish Dependencies
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        projectPath:
          - src/UnitySampleProject
        testMode:
          - PlayMode
    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true
        ssh-key: ${{ secrets.DEPLOY_KEY }}
    - name: Set up SSH keys
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ secrets.DEPLOY_KEY }}
    - name: Configure Git
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
    - name: Duplicate Web3 Unity Samples
      run: |
        export SOURCE_PATH=
        export DESTINATION_DIRECTORY=
        export DESTINATION_PATH=
        
        export DUPLICATE_SAMPLE_VARS=${{ vars.DUPLICATE_SAMPLE_VARS }}
        
        for entry in "${DUPLICATE_SAMPLE_VARS[@]}"
        do
          IFS=':' read -ra dirs <<< "$entry"
          SOURCE_PATH=${dirs[0]}
          DESTINATION_DIRECTORY=${dirs[1]}
          
          SOURCE_PATH="${GITHUB_WORKSPACE}/$SOURCE_PATH/$(ls "$SOURCE_PATH" | head -n 1)/$DESTINATION_DIRECTORY"
        
          DESTINATION_PATH="${GITHUB_WORKSPACE}/${dirs[2]}"
          
          rm -rf "$DESTINATION_PATH"
          mkdir -p "$DESTINATION_PATH"
          cp -r "$SOURCE_PATH/." "$DESTINATION_PATH"
        
          git add "$DESTINATION_PATH." -f
        done
    - name: Commit and Push changes
      if: ${{ github.ref_name == 'dev' }}
      run: |
        git diff-index --cached --quiet HEAD || git commit -m 'Auto Commit
        - Duplicate Packages Samples
        - Publish DLL Dependencies'
        git push -f